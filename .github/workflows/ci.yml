name: Build App and Push Image to ECR
on:
  workflow_dispatch:
    inputs:
      tag_value:
        description: 'Commit ID or git tag.'
        required: false
        type: string
      sast_checkpoint:
        description: 'Run SAST'
        required: true
        default: 'true'
        type: boolean
      dast_checkpoint:
        description: 'Run DAST'
        required: true
        default: 'true'
        type: boolean

  pull_request:
    branches:
      - main # THE TRUNK
    types:
      - opened
      - synchronize # runs again when commits are pushed to the PR
      - reopened

jobs:
  sast:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read
    defaults:
      run:
        working-directory: web_app

    if: >
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.sast_checkpoint == 'true')

    steps:
      # Daca am o valoare in textfieldul de tag_value, atunci descarc codul de la acel commit/tag
      - name: Get code from a specified commit/tag
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag_value != '' }}
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # number of commits to fetch (0 means ALL HISTORY)
          ref: ${{ github.event.inputs.tag_value }}

      # Otherwise, descarc codul de la latest commit on the branch or from the PR
      - name: Get code
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.tag_value != '') }}
        uses: actions/checkout@v3

      - name: Set up CodeQL
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.sast_checkpoint == 'true')
        uses: github/codeql-action/init@v3.28.21
        with:
          languages: javascript

      - name: Autobuild CodeQL
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.sast_checkpoint == 'true')
        uses: github/codeql-action/autobuild@v3.28.21

      - name: Run SAST Scan (Analyze)
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.sast_checkpoint == 'true')
        uses: github/codeql-action/analyze@v3.28.21
        with:
          category: '/language:javascript'

  dast:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    defaults:
      run:
        working-directory: web_app

    if: >
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.dast_checkpoint == 'true')

    steps:
      # Daca am o valoare in textfieldul de tag_value, atunci descarc codul de la acel commit/tag
      - name: Get code from a specified commit/tag
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag_value != '' }}
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # number of commits to fetch (0 means ALL HISTORY)
          ref: ${{ github.event.inputs.tag_value }}

      # Otherwise, descarc codul de la latest commit on the branch or from the PR
      - name: Get code
        if: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.tag_value != '') }}
        uses: actions/checkout@v3

      - name: Build Docker image for DAST
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.dast_checkpoint == 'true')
        run: docker build -t dast-test-app:latest .

      - name: Start Docker container for DAST
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.dast_checkpoint == 'true')
        run: docker run -d -p 80:80 --name dast-test-container dast-test-app:latest

      - name: Wait for application to start
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.dast_checkpoint == 'true')
        run: |
          for i in {1..30}; do
            if curl -s http://localhost:80 > /dev/null; then
              echo "Application is running"
              exit 0
            fi
            echo "Waiting for application... ($i/30)"
            sleep 2
          done
          echo "Application failed to start"
          exit 1
        shell: bash

      - name: Run DAST Scan with OWASP ZAP
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.dast_checkpoint == 'true')
        uses: zaproxy/action-full-scan@v0.13.0
        with:
          target: 'http://localhost:80'

      - name: Cleanup Docker container
        if: >
          github.event_name == 'pull_request' ||
          (github.event_name == 'workflow_dispatch' && github.event.inputs.dast_checkpoint == 'true')
        run: docker stop dast-test-container && docker rm dast-test-container

  build-and-push:
    # needs: [sast, dast]
    runs-on: ubuntu-latest
    if: |
      always() &&
      (needs.sast.result == 'success' || needs.sast.result == 'skipped') &&
      (needs.dast.result == 'success' || needs.dast.result == 'skipped')
    defaults:
      run:
      working-directory: web_app

    steps:
      # ... rest of your steps remain the same
